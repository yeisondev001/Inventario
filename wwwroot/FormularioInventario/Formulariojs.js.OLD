var productos = [];

// Cargar productos al iniciar
document.addEventListener('DOMContentLoaded', function () {
    cargarProductos();
});

document.getElementById('precioCompra').addEventListener('input', calcularMargen);
document.getElementById('precioVenta').addEventListener('input', calcularMargen);

function calcularMargen() {
    var precioCompra = parseFloat(document.getElementById('precioCompra').value) || 0;
    var precioVenta = parseFloat(document.getElementById('precioVenta').value) || 0;

    if (precioCompra === 0) {
        document.getElementById('margen').value = '0.00';
        return;
    }

    var margen = ((precioVenta - precioCompra) / precioCompra) * 100;
    document.getElementById('margen').value = margen.toFixed(2);
}

// Cargar productos desde la API
async function cargarProductos() {
    try {
        const response = await fetch('/products');

        if (!response.ok) {
            throw new Error('Error al cargar productos');
        }

        const data = await response.json();

        // Mapear productos de la API al formato local
        productos = data.map(function (p) {
            return {
                id: p.id,
                codigo: p.sku,
                descripcion: p.name,
                precioCompra: p.purchasePrice || 0,
                precioVenta: p.unitPrice,
                margen: p.purchasePrice > 0 ? ((p.unitPrice - p.purchasePrice) / p.purchasePrice) * 100 : 0,
                cantidad: p.stock || 0, // Usar el stock calculado por el backend
                subtotal: 0
            };
        });

        actualizarTabla();
    } catch (error) {
        console.error('Error cargando productos:', error);
        alert('Error al cargar los productos. Verifique la conexión con el servidor.');
    }
}

// Agregar producto a la base de datos
async function agregarProducto() {
    var codigo = document.getElementById('codigo').value.trim();
    var descripcion = document.getElementById('descripcion').value.trim();
    var precioCompra = parseFloat(document.getElementById('precioCompra').value);
    var precioVenta = parseFloat(document.getElementById('precioVenta').value);
    var cantidad = parseInt(document.getElementById('cantidad').value);

    if (!codigo || !descripcion || isNaN(precioCompra) || isNaN(precioVenta) || isNaN(cantidad)) {
        alert('Por favor complete todos los campos correctamente');
        return;
    }

    if (precioCompra <= 0 || precioVenta <= 0 || cantidad <= 0) {
        alert('Los valores deben ser mayores a 0');
        return;
    }

    // Crear el producto en la API
    try {
        // Primero crear el producto
        const productoData = {
            sku: codigo,
            name: descripcion,
            description: descripcion, // Usar la misma descripción como detalle
            purchasePrice: precioCompra,
            unitPrice: precioVenta,
            categoryId: 1 // Categoría por defecto "General"
        };

        const responseProducto = await fetch('/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(productoData)
        });

        if (!responseProducto.ok) {
            const errorData = await responseProducto.json();
            throw new Error(errorData.message || 'Error al crear producto');
        }

        const productoCreado = await responseProducto.json();

        // Luego crear un movimiento de entrada con la cantidad inicial
        const movementData = {
            productId: productoCreado.id,
            warehouseId: 1, // Almacén por defecto "Principal"
            type: 1, // 1 = In (Entrada) - CORREGIDO de 0 a 1
            quantity: cantidad,
            movementDate: new Date().toISOString(), // CORREGIDO: era 'date'
            reference: 'Inventario inicial' // CORREGIDO: era 'notes'
        };

        const responseMovement = await fetch('/movements', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(movementData)
        });

        if (!responseMovement.ok) {
            const errorData = await responseMovement.json();
            throw new Error(errorData.message || 'Error al registrar inventario inicial');
        }

        alert('✅ Producto agregado exitosamente');
        limpiarFormulario();
        cargarProductos(); // Recargar la lista

    } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al guardar el producto: ' + error.message);
    }
}

async function eliminarProducto(id) {
    // Buscar el producto para mostrar su información
    var producto = productos.find(function (p) { return p.id === id; });

    if (!producto) {
        alert('Producto no encontrado');
        return;
    }

    // Confirmar antes de eliminar
    var mensaje = '⚠️ ¿Está seguro de eliminar este producto?\n\n' +
        'Código: ' + producto.codigo + '\n' +
        'Descripción: ' + producto.descripcion + '\n' +
        'Cantidad en stock: ' + producto.cantidad + '\n\n' +
        'Esta acción no se puede deshacer.';

    if (!confirm(mensaje)) {
        return; // Usuario canceló
    }

    try {
        const response = await fetch('/products/' + id, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Error al eliminar el producto');
        }

        alert('✅ Producto eliminado exitosamente');

        // Actualizar la lista local y recargar desde el servidor
        productos = productos.filter(function (p) { return p.id !== id; });
        actualizarTabla();

        // Recargar desde el servidor para asegurar sincronización
        cargarProductos();

    } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al eliminar el producto: ' + error.message);
    }
}

function actualizarTabla() {
    var tbody = document.getElementById('productosTableBody');
    var productsCard = document.getElementById('productsCard');

    if (productos.length === 0) {
        productsCard.classList.remove('show');
        return;
    }

    productsCard.classList.add('show');
    tbody.innerHTML = '';

    productos.forEach(function (producto) {
        var tr = document.createElement('tr');
        var margen = producto.margen || 0;
        var margenClass = margen >= 0 ? 'margin-positive' : 'margin-negative';
        var subtotal = (producto.precioVenta * producto.cantidad).toFixed(2);

        tr.innerHTML =
            '<td class="code-cell">' + producto.codigo + '</td>' +
            '<td class="description-cell">' + producto.descripcion + '</td>' +
            '<td class="text-right">$' + parseFloat(producto.precioCompra).toFixed(2) + '</td>' +
            '<td class="text-right">$' + parseFloat(producto.precioVenta).toFixed(2) + '</td>' +
            '<td class="text-right">' +
            '<span class="margin-badge ' + margenClass + '">' + margen.toFixed(2) + '%</span>' +
            '</td>' +
            '<td class="text-right">' + producto.cantidad + '</td>' +
            '<td class="text-right subtotal-cell">$' + subtotal + '</td>' +
            '<td class="text-center">' +
            '<button class="delete-btn" onclick="eliminarProducto(' + producto.id + ')" title="Eliminar producto">' +
            '&#128465;' +
            '</button>' +
            '</td>';

        tbody.appendChild(tr);
    });

    var total = productos.reduce(function (sum, p) {
        return sum + (parseFloat(p.precioVenta) * p.cantidad);
    }, 0);

    document.getElementById('totalProductos').textContent = productos.length;
    document.getElementById('totalValor').textContent = '$' + total.toFixed(2);
    document.getElementById('totalFooter').textContent = '$' + total.toFixed(2);
}

function limpiarFormulario() {
    document.getElementById('codigo').value = '';
    document.getElementById('descripcion').value = '';
    document.getElementById('precioCompra').value = '';
    document.getElementById('precioVenta').value = '';
    document.getElementById('cantidad').value = '';
    document.getElementById('margen').value = '0.00';
}

function generarReporte() {
    if (productos.length === 0) {
        alert('No hay productos en el inventario para generar el reporte');
        return;
    }

    var totalInventario = productos.reduce(function (sum, p) {
        return sum + (parseFloat(p.precioVenta) * p.cantidad);
    }, 0);
    var totalUnidades = productos.reduce(function (sum, p) {
        return sum + p.cantidad;
    }, 0);

    alert('REPORTE DE INVENTARIO\n\n' +
        'Total de productos: ' + productos.length + '\n' +
        'Total de unidades: ' + totalUnidades + '\n' +
        'Valor total: $' + totalInventario.toFixed(2));
}